@page "/Profile"
@inject UserService UserService
@inject NavigationManager NavigationManager
@using m1Chat.Client.Services

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudPaper Elevation="3" Class="pa-4 rounded-lg blur-background">
        <MudGrid Spacing="0">
            <MudItem xs="12" Class="d-flex align-center"> 
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                               Color="Color.Inherit"
                               OnClick="NavigateToChat"
                               Edge="Edge.Start" />
                <MudText Typo="Typo.h5" Class="flex-grow-1 text-center pr-10">
                    User Profile
                </MudText>
            </MudItem>

            <MudItem xs="12" Class="mb-4">
                <MudCard Elevation="0">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-2">Account Information</MudText>
                        <MudList T="string">
                            <MudListItem Text="Email" SecondaryText="@UserEmail" />
                        </MudList>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" Class="mb-4">
                <MudCard Elevation="0">
                    <MudCardContent>
                        <MudText Typo="Typo.h6" Class="mb-2">Usage Statistics</MudText>
                        <MudGrid>
                            <MudItem xs="12" sm="4" Class="text-center">
                                <MudText Typo="Typo.h4" Color="Color.Primary">@TotalChats</MudText>
                                <MudText>Chat Threads</MudText>
                            </MudItem>
                            <MudItem xs="12" sm="4" Class="text-center">
                                <MudText Typo="Typo.h4" Color="Color.Primary">@TotalMessages</MudText>
                            <MudText>Messages Sent</MudText>
                            </MudItem>
                        </MudGrid>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" Class="text-center mt-4">
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.Logout"
                           OnClick="Logout"
                           Class="mt-4">
                    Logout
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    private string UserEmail { get; set; } = "Loading...";
    private int TotalChats = 0;
    private int TotalMessages = 0;

    protected override async Task OnInitializedAsync()
    {
        UserEmail = await UserService.GetUserEmailAsync() ?? "Unknown";
        var stats = await UserService.GetUserStatsAsync();
        if (stats != null)
        {
            TotalChats = stats.TotalChats;
            TotalMessages = stats.TotalMessages;
        }
        else
        {
            Console.WriteLine("Could not fetch user stats.");
            TotalChats = 0;
            TotalMessages = 0;
        }
    }

    private void Logout()
    {
        NavigationManager.NavigateTo("/", forceLoad: true);
    }

    private void NavigateToChat()
    {
        NavigationManager.NavigateTo("/Chat");
    }
}
