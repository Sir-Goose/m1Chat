@* UserMarkdown.razor *@
@using System.ComponentModel.DataAnnotations
@using Markdig
@inject IJSRuntime JS
@using Ganss.Xss

@* Render the content inside a simple div. The parent MudChatBubble will handle the bubble styling and alignment. *@
<div @ref="userDiv"></div>

@code {
    [Parameter] public required string Markdown { get; set; }

    private ElementReference userDiv;
    private string _lastMarkdown;

    // Use the same pipeline configuration as AiMarkdown for consistency
    private static readonly MarkdownPipeline _pipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private static readonly HtmlSanitizer _htmlSanitizer = new HtmlSanitizer();
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Check if the markdown content has actually changed to avoid unnecessary JS calls
        if (Markdown != _lastMarkdown)
        {
            _lastMarkdown = Markdown;
            // 1. Convert Markdown to HTML
            var unsafeHtml = Markdig.Markdown.ToHtml(Markdown ?? "", _pipeline);
            // 2. SANITIZE THE HTML OUTPUT
            var safeHtml = _htmlSanitizer.Sanitize(unsafeHtml);
            // Use the same JS interop function as AiMarkdown
            await JS.InvokeVoidAsync("setInnerHtmlAndRenderMath", userDiv, safeHtml);
        }
    }
}