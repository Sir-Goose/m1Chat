@using Markdig
@inject IJSRuntime JS
<style>
    /* Hide native scrollbars but keep vertical scrolling */
    .no-scrollbar {
        overflow-y: auto;
        overflow-x: hidden;
        -ms-overflow-style: none;  /* IE/Edge */
        scrollbar-width: none;      /* Firefox */
    }
    .no-scrollbar::-webkit-scrollbar {
        display: none;              /* Chrome/Safari/Opera */
    }

    /* Kill MudMainContent's top-padding (for an AppBar) */
    .mud-main-content {
        padding-top: 0 !important;
    }

    /* Chat viewport height (subtract header+footer) */
    .chat-container {
        overflow-y: auto;
        height: calc(100vh - 128px);
    }

    /* User bubble is capped to ~60% width */
    .user-message {
        max-width: 60%;
        margin: auto;
        line-height: 1.43;
        font-size: 1rem;
    }

    /* AI message is plain full-width text */
    .ai-message {
        display: block;
        width: 70%;
        margin: auto;
        white-space: normal;
        line-height: 1.43;
        padding: 1rem;
    }

    /* Style the horizontal rule within .ai-message */
    .ai-message hr {
        border: none;
        height: 1px;
        background-color: var(--mud-palette-primary);
        padding: 0;
        margin: 1rem 0;
    }

    /* Heading styles with padding */
    .ai-message h1 {
        padding: 1.5rem 0 1.5rem 0;
        margin: 0;
    }
    .ai-message h2 {
        padding: 1.25rem 0 1.25rem 0;
        margin: 0;
    }
    .ai-message h3 {
        padding: 1rem 0 1rem 0;
        margin: 0;
    }
    .ai-message h4,
    .ai-message h5,
    .ai-message h6 {
        padding: 0.75rem 0 0.75rem 0;
        margin: 0;
    }

    /* restore list styling inside .ai-message */
    .ai-message ul,
    .ai-message ol {
        padding: 0.75rem;
        list-style-position: inside;
    }
    .ai-message ul li::marker,
    .ai-message ol li::marker {
        color: var(--mud-palette-primary);
    }

    .ai-message li {
        margin: 1rem 0;
    }

    /* Style blockquotes within .ai-message */
    .ai-message blockquote {
        border-left: 4px solid var(--mud-palette-primary-lighten);
        padding: 0rem 0rem;
        margin: 1rem 0;
        background-color: var(--mud-palette-background-grey);
        color: var(--mud-palette-text);
        font-style: italic;
    }

    /* Ensure paragraphs inside blockquotes don't add extra margin */
    .ai-message blockquote p {
        margin-bottom: 0;
        padding: 0.75rem;
    }

    /* style links so they look "linky" again */
    .ai-message a {
        color: var("red");
        text-decoration: underline;
    }

    /* Customized code-block styling */
    .ai-message pre {
        background: var(--mud-palette-background);
        border: 1px solid var(--mud-palette-divider);
        border-left: 3px solid var(--mud-palette-primary);
        border-radius: 4px;
        padding: 0.75rem;
        margin: 1rem 0;
        font-family: Consolas, Monaco, 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.4;
        overflow-x: auto;
    }

    .ai-message pre code {
        display: block;
        color: var(--mud-palette-text-primary);
        background: transparent;
        white-space: pre;
    }

    /* Table styling inside .ai-message */
    .ai-message table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
        font-size: 1rem;
        overflow-x: auto;
        display: block;
        border: none; /* Remove outer border */
    }

    .ai-message th,
    .ai-message td {
        border: none; /* Remove all borders */
        border-bottom: 1px solid var(--mud-palette-divider); /* Only horizontal dividers */
        padding: 0.75rem 1rem;
        text-align: left;
        vertical-align: top;
    }

    .ai-message th {
        font-weight: 600;
        border-bottom: 1px solid var(--mud-palette-drawer-text); /* Distinct divider below headers */
    }

    /* Make the first row after the header have a distinct border if needed */
    .ai-message tr:first-of-type td {
        border-bottom: 1px solid var(--mud-palette-divider);
    }


    .ai-message caption {
        caption-side: bottom;
        padding: 0.5rem;
        color: var(--mud-palette-text-secondary);
        font-size: 0.95em;
        text-align: left;
    }

</style>


<div @ref="aiDiv" class="ai-message"></div>

@code {
    [Parameter]
    public string Markdown { get; set; }

    private ElementReference aiDiv;
    private string _lastMarkdown;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Markdown != _lastMarkdown)
        {
            _lastMarkdown = Markdown;
            var html = Markdig.Markdown.ToHtml(Markdown ?? "");
            await JS.InvokeVoidAsync("setInnerHtmlAndRenderMath", aiDiv, html);
        }
    }
}