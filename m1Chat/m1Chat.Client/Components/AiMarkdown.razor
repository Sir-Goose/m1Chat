@using Markdig
@inject IJSRuntime Js
@using Ganss.Xss

<div @ref="_aiDiv" class="mud-typography-body1 ai-message"></div>

@code {
    [Parameter] public string Markdown { get; set; } = "";

    private ElementReference _aiDiv;
    private string _lastMarkdown = "";

    // pipeline with table support, fenced code, lists, footnotes, etc.
    private static readonly MarkdownPipeline Pipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private static readonly HtmlSanitizer HtmlSanitizer = new HtmlSanitizer();
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        HtmlSanitizer.AllowedTags.Add("pre");
        HtmlSanitizer.AllowedTags.Add("code");
        HtmlSanitizer.AllowedTags.Add("span");;
        HtmlSanitizer.AllowedAttributes.Add("class");
        if (Markdown != _lastMarkdown)
        {
            _lastMarkdown = Markdown;
            // 1. Convert Markdown to HTML
            var unsafeHtml = Markdig.Markdown.ToHtml(Markdown, Pipeline);
            // 2. SANITIZE THE HTML OUTPUT
            var safeHtml = HtmlSanitizer.Sanitize(unsafeHtml);
            // Use the same JS interop function as AiMarkdown
            await Js.InvokeVoidAsync("setInnerHtmlAndRenderMath", _aiDiv, safeHtml);
        }
    }
}